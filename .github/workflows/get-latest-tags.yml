name: Get Latest GHCR Image Tags

on:
  workflow_dispatch:

jobs:
  get-latest-tags:
    runs-on: ubuntu-latest
    permissions:
      packages: read
      contents: read
    steps:
      - name: Get latest tag for Auth
        id: auth_tag
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/packages/container/mg-erp%2Fmg-erp-auth/versions")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "Auth HTTP Code: $HTTP_CODE"
          echo "Auth Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "latest=not-published" >> $GITHUB_OUTPUT
            echo "Auth: not-published (image not in GHCR)"
          else
            LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[]? // empty' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            if [ -z "$LATEST" ]; then
              LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[0]? // empty' | grep -v "latest" | head -n 1)
            fi
            echo "latest=${LATEST:-none}" >> $GITHUB_OUTPUT
            echo "Auth: ${LATEST:-none}"
          fi

      - name: Get latest tag for Inventory
        id: inventory_tag
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/mg-erp-inventory/versions")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "Inventory HTTP Code: $HTTP_CODE"
          echo "Inventory Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "latest=not-published" >> $GITHUB_OUTPUT
            echo "Inventory: not-published"
          else
            LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[]? // empty' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            if [ -z "$LATEST" ]; then
              LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[0]? // empty' | grep -v "latest" | head -n 1)
            fi
            echo "latest=${LATEST:-none}" >> $GITHUB_OUTPUT
            echo "Inventory: ${LATEST:-none}"
          fi

      - name: Get latest tag for Ledger
        id: ledger_tag
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/mg-erp-ledger/versions")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "Ledger HTTP Code: $HTTP_CODE"
          echo "Ledger Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "latest=not-published" >> $GITHUB_OUTPUT
            echo "Ledger: not-published"
          else
            LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[]? // empty' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            if [ -z "$LATEST" ]; then
              LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[0]? // empty' | grep -v "latest" | head -n 1)
            fi
            echo "latest=${LATEST:-none}" >> $GITHUB_OUTPUT
            echo "Ledger: ${LATEST:-none}"
          fi

      - name: Get latest tag for POS
        id: pos_tag
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/mg-erp-pos/versions")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "POS HTTP Code: $HTTP_CODE"
          echo "POS Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "latest=not-published" >> $GITHUB_OUTPUT
            echo "POS: not-published"
          else
            LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[]? // empty' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            if [ -z "$LATEST" ]; then
              LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[0]? // empty' | grep -v "latest" | head -n 1)
            fi
            echo "latest=${LATEST:-none}" >> $GITHUB_OUTPUT
            echo "POS: ${LATEST:-none}"
          fi

      - name: Get latest tag for Portal
        id: portal_tag
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/mg-erp-portal/versions")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "Portal HTTP Code: $HTTP_CODE"
          echo "Portal Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "404" ]; then
            echo "latest=not-published" >> $GITHUB_OUTPUT
            echo "Portal: not-published"
          else
            LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[]? // empty' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            if [ -z "$LATEST" ]; then
              LATEST=$(echo "$BODY" | jq -r '.[].metadata.container.tags[0]? // empty' | grep -v "latest" | head -n 1)
            fi
            echo "latest=${LATEST:-none}" >> $GITHUB_OUTPUT
            echo "Portal: ${LATEST:-none}"
          fi

      - name: Summary
        run: |
          echo "# Latest GHCR Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ghcr.io/${{ github.repository_owner }}/mg-erp-auth | ${{ steps.auth_tag.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Inventory | ghcr.io/${{ github.repository_owner }}/mg-erp-inventory | ${{ steps.inventory_tag.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ledger | ghcr.io/${{ github.repository_owner }}/mg-erp-ledger | ${{ steps.ledger_tag.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| POS | ghcr.io/${{ github.repository_owner }}/mg-erp-pos | ${{ steps.pos_tag.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Portal | ghcr.io/${{ github.repository_owner }}/mg-erp-portal | ${{ steps.portal_tag.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository_owner }}/mg-erp-auth:${{ steps.auth_tag.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository_owner }}/mg-erp-inventory:${{ steps.inventory_tag.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository_owner }}/mg-erp-ledger:${{ steps.ledger_tag.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository_owner }}/mg-erp-pos:${{ steps.pos_tag.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository_owner }}/mg-erp-portal:${{ steps.portal_tag.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create artifacts
        run: |
          mkdir -p artifacts
          cat > artifacts/tags.json << EOF
          {
            "auth": "${{ steps.auth_tag.outputs.latest }}",
            "inventory": "${{ steps.inventory_tag.outputs.latest }}",
            "ledger": "${{ steps.ledger_tag.outputs.latest }}",
            "pos": "${{ steps.pos_tag.outputs.latest }}",
            "portal": "${{ steps.portal_tag.outputs.latest }}"
          }
          EOF
          cat > artifacts/tags.env << EOF
          AUTH_TAG=${{ steps.auth_tag.outputs.latest }}
          INVENTORY_TAG=${{ steps.inventory_tag.outputs.latest }}
          LEDGER_TAG=${{ steps.ledger_tag.outputs.latest }}
          POS_TAG=${{ steps.pos_tag.outputs.latest }}
          PORTAL_TAG=${{ steps.portal_tag.outputs.latest }}
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ghcr-tags
          path: artifacts/
          retention-days: 90
